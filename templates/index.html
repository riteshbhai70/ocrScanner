<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Scanner - Google Lens Style</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        :root {
    --primary-color: #4285f4;
    --secondary-color: #34a853;
    --accent-color: #ea4335;
    --background-color: #f8f9fa;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

body {
    background-color: var(--background-color);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.card {
    border: none;
    border-radius: 12px;
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.drop-zone {
    border: 3px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem;
    transition: all 0.3s ease;
    cursor: pointer;
    background: white;
}

.drop-zone:hover, .drop-zone.dragover {
    border-color: var(--primary-color);
    background-color: #f8fbff;
}

.file-preview {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.file-preview:hover {
    border-color: var(--primary-color);
    box-shadow: var(--card-shadow);
}

.file-preview img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.file-preview .file-info {
    padding: 0.5rem;
    background: white;
}

.file-preview .remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-preview .remove-btn:hover {
    background: var(--accent-color);
    color: white;
}

.result-item {
    border-left: 4px solid var(--primary-color);
    background: white;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.result-item.success {
    border-left-color: var(--secondary-color);
}

.result-item.error {
    border-left-color: var(--accent-color);
}

.text-output {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color), #5b7cff);
    border: none;
    border-radius: 25px;
    padding: 0.75rem 2rem;
    font-weight: 600;
}

.btn-success {
    background: linear-gradient(135deg, var(--secondary-color), #4caf50);
    border: none;
    border-radius: 25px;
    padding: 0.75rem 2rem;
    font-weight: 600;
}

.spinner-border {
    animation-duration: 0.8s;
}

/* Responsive design */
@media (max-width: 768px) {
    .drop-zone {
        padding: 2rem 1rem;
    }
    
    .display-4 {
        font-size: 2rem;
    }
}

/* Animation for file addition */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.file-preview {
    animation: fadeIn 0.3s ease;
}


/* Add to existing CSS */

.preview-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
    z-index: 10;
}

.remove-btn {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.remove-btn:hover {
    background: var(--accent-color);
    color: white;
}

.rotate-controls {
    display: flex;
    gap: 2px;
}

.rotate-btn {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.rotate-btn:hover {
    background: var(--primary-color);
    color: white;
}

.rotation-indicator {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
}

.file-preview {
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.file-preview:hover {
    border-color: var(--primary-color);
    box-shadow: var(--card-shadow);
}

.file-preview img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.file-preview .file-info {
    padding: 0.5rem;
    background: white;
}

/* Toast notifications */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-left: 4px solid var(--primary-color);
    border-radius: 4px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateX(400px);
    transition: transform 0.3s ease;
    z-index: 1000;
    max-width: 300px;
}

.toast-notification.show {
    transform: translateX(0);
}

.toast-notification.toast-error {
    border-left-color: var(--accent-color);
}

.toast-content {
    display: flex;
    align-items: center;
    font-weight: 500;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .preview-controls {
        flex-direction: column;
    }
    
    .rotate-controls {
        flex-direction: row;
    }
    
    .toast-notification {
        left: 20px;
        right: 20px;
        max-width: none;
        transform: translateY(-100px);
    }
    
    .toast-notification.show {
        transform: translateY(0);
    }
}
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="text-center py-4 mb-4">
            <h1 class="display-4 fw-bold text-primary">
                <i class="fas fa-camera me-3"></i>OCR Scanner
            </h1>
            <p class="lead text-muted">Extract text from images and PDFs like Google Lens</p>
        </header>

        <!-- Main Content -->
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <!-- Upload Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center p-5">
                        <div id="dropZone" class="drop-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h4>Drag & Drop Files Here</h4>
                            <p class="text-muted">Supported formats: JPG, PNG, PDF, GIF, BMP, TIFF</p>
                            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.pdf,.gif,.bmp,.tiff" hidden>
                            <button class="btn btn-primary btn-lg mt-3" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open me-2"></i>Choose Files
                            </button>
                        </div>
                    </div>
                </div>

                <!-- File Previews -->
                <div id="previewSection" class="card shadow-sm mb-4" style="display: none;">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-images me-2"></i>Selected Files</h5>
                    </div>
                    <div class="card-body">
                        <div id="filePreviews" class="row g-3"></div>
                    </div>
                    <div class="card-footer text-end">
                        <button id="scanBtn" class="btn btn-success btn-lg" onclick="processOCR()">
                            <i class="fas fa-search me-2"></i>Scan Text
                        </button>
                    </div>
                </div>

                <!-- Loading Animation -->
                <div id="loadingSection" class="text-center mb-4" style="display: none;">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-3 text-muted">Processing your files... This may take a moment.</p>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="card shadow-sm" style="display: none;">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-text me-2"></i>Extracted Text</h5>
                        <button id="downloadBtn" class="btn btn-outline-primary btn-sm" onclick="downloadText()">
                            <i class="fas fa-download me-1"></i>Download Text
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="resultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center py-4 mt-5">
            <p class="text-muted">Powered by Flask & Tesseract OCR</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        class OCRScanner {
    constructor() {
        this.selectedFiles = [];
        this.initEventListeners();
    }

    initEventListeners() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // Drag and drop events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            this.handleFiles(e.dataTransfer.files);
        });

        // File input change event
        fileInput.addEventListener('change', (e) => {
            this.handleFiles(e.target.files);
        });
    }

    handleFiles(files) {
        for (let file of files) {
            if (this.isValidFile(file)) {
                this.addFile(file);
            } else {
                this.showError(`File type not supported: ${file.name}`);
            }
        }
        this.updateUI();
    }

    isValidFile(file) {
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/tiff', 'application/pdf'];
        return allowedTypes.includes(file.type);
    }

    addFile(file) {
        const fileId = Date.now() + Math.random();
        this.selectedFiles.push({
            id: fileId,
            file: file,
            previewUrl: this.generatePreview(file),
            rotation: 0, // Track rotation angle
            processedFile: null // Store rotated file for upload
        });
    }

    generatePreview(file) {
        if (file.type.startsWith('image/')) {
            return URL.createObjectURL(file);
        } else if (file.type === 'application/pdf') {
            return 'https://cdn-icons-png.flaticon.com/512/337/337946.png'; // PDF icon
        }
        return '';
    }

    removeFile(fileId) {
        const fileData = this.selectedFiles.find(f => f.id === fileId);
        if (fileData && fileData.previewUrl) {
            URL.revokeObjectURL(fileData.previewUrl);
        }
        this.selectedFiles = this.selectedFiles.filter(f => f.id !== fileId);
        this.updateUI();
    }

    rotateFile(fileId, degrees) {
        const fileData = this.selectedFiles.find(f => f.id === fileId);
        if (!fileData || !fileData.file.type.startsWith('image/')) return;

        fileData.rotation = (fileData.rotation + degrees) % 360;
        
        // Create rotated preview
        this.createRotatedPreview(fileData).then(previewUrl => {
            if (fileData.previewUrl) {
                URL.revokeObjectURL(fileData.previewUrl);
            }
            fileData.previewUrl = previewUrl;
            this.updateUI();
        });
    }

    async createRotatedPreview(fileData) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Set canvas size based on rotation
                if (fileData.rotation === 90 || fileData.rotation === 270) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                
                // Translate to center and rotate
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(fileData.rotation * Math.PI / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                
                ctx.restore();
                
                resolve(canvas.toDataURL());
            };
            
            img.src = URL.createObjectURL(fileData.file);
        });
    }

    async getProcessedFile(fileData) {
        if (fileData.rotation === 0) {
            return fileData.file; // Return original if no rotation
        }

        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Set canvas size based on rotation
                if (fileData.rotation === 90 || fileData.rotation === 270) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                
                // Translate to center and rotate
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(fileData.rotation * Math.PI / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                
                ctx.restore();
                
                // Convert canvas to blob
                canvas.toBlob((blob) => {
                    const rotatedFile = new File([blob], fileData.file.name, {
                        type: fileData.file.type,
                        lastModified: new Date().getTime()
                    });
                    resolve(rotatedFile);
                }, fileData.file.type);
            };
            
            img.src = URL.createObjectURL(fileData.file);
        });
    }

    updateUI() {
        const previewSection = document.getElementById('previewSection');
        const filePreviews = document.getElementById('filePreviews');

        if (this.selectedFiles.length > 0) {
            previewSection.style.display = 'block';
            filePreviews.innerHTML = '';

            this.selectedFiles.forEach(fileData => {
                const previewHtml = this.createPreviewHtml(fileData);
                filePreviews.innerHTML += previewHtml;
            });
        } else {
            previewSection.style.display = 'none';
        }
    }

    createPreviewHtml(fileData) {
        const isPDF = fileData.file.type === 'application/pdf';
        const isImage = fileData.file.type.startsWith('image/');
        const icon = isPDF ? 'fa-file-pdf' : 'fa-file-image';
        const bgClass = isPDF ? 'bg-danger' : 'bg-success';

        return `
            <div class="col-md-4 col-sm-6">
                <div class="file-preview">
                    <div class="preview-controls">
                        <div class="remove-btn" onclick="ocrScanner.removeFile(${fileData.id})">
                            <i class="fas fa-times"></i>
                        </div>
                        ${isImage ? `
                            <div class="rotate-controls">
                                <button class="rotate-btn rotate-left" onclick="ocrScanner.rotateFile(${fileData.id}, -90)" title="Rotate Left">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="rotate-btn rotate-right" onclick="ocrScanner.rotateFile(${fileData.id}, 90)" title="Rotate Right">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                            ${fileData.rotation !== 0 ? `
                                <div class="rotation-indicator">
                                    <small>${fileData.rotation}Â°</small>
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>
                    ${isPDF ? 
                        `<div class="d-flex align-items-center justify-content-center bg-light" style="height: 120px;">
                            <i class="fas ${icon} fa-3x text-danger"></i>
                        </div>` :
                        `<img src="${fileData.previewUrl}" alt="${fileData.file.name}" style="transform: rotate(${fileData.rotation}deg); transition: transform 0.3s ease;">`
                    }
                    <div class="file-info">
                        <small class="text-truncate d-block" title="${fileData.file.name}">
                            <i class="fas ${icon} ${bgClass} text-white p-1 rounded me-1"></i>
                            ${fileData.file.name}
                        </small>
                        <small class="text-muted">${this.formatFileSize(fileData.file.size)}</small>
                    </div>
                </div>
            </div>
        `;
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async processOCR() {
        if (this.selectedFiles.length === 0) {
            this.showError('Please select at least one file to scan.');
            return;
        }

        this.showLoading(true);
        this.hideResults();

        const formData = new FormData();
        
        // Process files with rotations
        for (const fileData of this.selectedFiles) {
            let fileToUpload = fileData.file;
            
            if (fileData.file.type.startsWith('image/') && fileData.rotation !== 0) {
                fileToUpload = await this.getProcessedFile(fileData);
            }
            
            formData.append('files[]', fileToUpload);
        }

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                this.displayResults(data.results);
            } else {
                throw new Error(data.error || 'Server error');
            }
        } catch (error) {
            this.showError('Error processing files: ' + error.message);
        } finally {
            this.showLoading(false);
        }
    }

    displayResults(results) {
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');

        resultsContent.innerHTML = '';

        results.forEach((result, index) => {
            const resultClass = result.success ? 'success' : 'error';
            const icon = result.success ? 'fa-check-circle text-success' : 'fa-exclamation-circle text-danger';

            const resultHtml = `
                <div class="result-item ${resultClass} p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <i class="fas ${icon} me-2"></i>${result.filename}
                        </h6>
                        <small class="text-muted">${result.success ? 'Success' : 'Error'}</small>
                    </div>
                    <div class="text-output">${result.text || 'No text extracted'}</div>
                </div>
            `;
            resultsContent.innerHTML += resultHtml;
        });

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    downloadText() {
        const results = document.querySelectorAll('.text-output');
        let fullText = '';

        results.forEach((result, index) => {
            const filename = this.selectedFiles[index]?.file.name || `file_${index + 1}`;
            fullText += `=== ${filename} ===\n\n`;
            fullText += result.textContent + '\n\n';
        });

        const blob = new Blob([fullText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `extracted_text_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    showLoading(show) {
        const loadingSection = document.getElementById('loadingSection');
        const scanBtn = document.getElementById('scanBtn');

        if (show) {
            loadingSection.style.display = 'block';
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        } else {
            loadingSection.style.display = 'none';
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<i class="fas fa-search me-2"></i>Scan Text';
        }
    }

    hideResults() {
        document.getElementById('resultsSection').style.display = 'none';
    }

    showError(message) {
        // Create a nice toast notification instead of alert
        this.showToast(message, 'error');
    }

    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Add show class after a delay
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Remove after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }
}

// Initialize the OCR scanner when the page loads
let ocrScanner;

document.addEventListener('DOMContentLoaded', function() {
    ocrScanner = new OCRScanner();
});

// Global functions for HTML onclick events
function processOCR() {
    ocrScanner.processOCR();
}

function downloadText() {
    ocrScanner.downloadText();
}
    </script>
</body>
</html>